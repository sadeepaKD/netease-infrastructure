# SQL Queries Configuration for MySQL/MariaDB
# Used by the sql module for FreeRADIUS 3.0

# Safe characters for SQL queries
safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /+"

#######################################################################
# Authorization Queries
#######################################################################

authorize_check_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authcheck_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_reply_query = "\
    SELECT id, username, attribute, value, op \
    FROM ${authreply_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_group_check_query = "\
    SELECT id, groupname, attribute, \
    Value, op \
    FROM ${groupcheck_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

authorize_group_reply_query = "\
    SELECT id, groupname, attribute, \
    value, op \
    FROM ${groupreply_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

group_membership_query = "\
    SELECT groupname \
    FROM ${usergroup_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY priority"

#######################################################################
# Accounting Queries
#######################################################################

accounting {
    reference = "%{tolower:type.%{Acct-Status-Type}.query}"

    type {
        start {
            query = "\
                INSERT INTO ${....acct_table1} \
                    (acctsessionid, acctuniqueid, username, \
                    realm, nasipaddress, nasportid, \
                    nasporttype, acctstarttime, \
                    acctupdatetime, acctstoptime, \
                    acctsessiontime, acctauthentic, \
                    connectinfo_start, connectinfo_stop, \
                    acctinputoctets, acctoutputoctets, \
                    calledstationid, callingstationid, \
                    acctterminatecause, servicetype, \
                    framedprotocol, framedipaddress, \
                    framedipv6address, framedipv6prefix, \
                    framedinterfaceid, delegatedipv6prefix) \
                VALUES \
                    ('%{Acct-Session-Id}', '%{Acct-Unique-Session-Id}', '%{SQL-User-Name}', \
                    '%{Realm}', '%{NAS-IP-Address}', '%{%{NAS-Port-ID}:-}', \
                    '%{NAS-Port-Type}', FROM_UNIXTIME(%{integer:Event-Timestamp}), \
                    FROM_UNIXTIME(%{integer:Event-Timestamp}), NULL, \
                    '0', '%{Acct-Authentic}', \
                    '%{Connect-Info}', '', \
                    '0', '0', \
                    '%{Called-Station-Id}', '%{Calling-Station-Id}', \
                    '', '%{Service-Type}', \
                    '%{Framed-Protocol}', '%{Framed-IP-Address}', \
                    '%{Framed-IPv6-Address}', '%{Framed-IPv6-Prefix}', \
                    '%{Framed-Interface-Id}', '%{Delegated-IPv6-Prefix}')"
        }

        interim-update {
            query = "\
                UPDATE ${....acct_table1} SET \
                    acctupdatetime  = FROM_UNIXTIME(%{integer:Event-Timestamp}), \
                    acctinterval    = '%{Acct-Delay-Time:-0}' + %{integer:Event-Timestamp} - \
                        UNIX_TIMESTAMP(acctupdatetime), \
                    framedipaddress = '%{Framed-IP-Address}', \
                    framedipv6address = '%{Framed-IPv6-Address}', \
                    framedipv6prefix = '%{Framed-IPv6-Prefix}', \
                    framedinterfaceid = '%{Framed-Interface-Id}', \
                    delegatedipv6prefix = '%{Delegated-IPv6-Prefix}', \
                    acctsessiontime = '%{Acct-Session-Time}', \
                    acctinputoctets = '%{%{Acct-Input-Gigawords}:-0}' << 32 | \
                        '%{%{Acct-Input-Octets}:-0}', \
                    acctoutputoctets = '%{%{Acct-Output-Gigawords}:-0}' << 32 | \
                        '%{%{Acct-Output-Octets}:-0}' \
                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
        }

        stop {
            query = "\
                UPDATE ${....acct_table2} SET \
                    acctstoptime       = FROM_UNIXTIME(%{integer:Event-Timestamp}), \
                    acctsessiontime    = '%{Acct-Session-Time}', \
                    acctinputoctets    = '%{%{Acct-Input-Gigawords}:-0}' << 32 | \
                        '%{%{Acct-Input-Octets}:-0}', \
                    acctoutputoctets   = '%{%{Acct-Output-Gigawords}:-0}' << 32 | \
                        '%{%{Acct-Output-Octets}:-0}', \
                    acctterminatecause = '%{Acct-Terminate-Cause}', \
                    connectinfo_stop   = '%{Connect-Info}' \
                WHERE acctuniqueid = '%{Acct-Unique-Session-Id}'"
        }
    }
}

#######################################################################
# Post-Auth Queries
#######################################################################

post-auth {
    query = "\
        INSERT INTO ${..postauth_table} \
            (username, pass, reply, authdate) \
        VALUES ( \
            '%{SQL-User-Name}', \
            '%{%{User-Password}:-Chap-Password}', \
            '%{reply:Packet-Type}', \
            NOW())"
}
